services:
  # Neo4j - Graph Database for Graphiti
  neo4j:
    image: neo4j:5.16-community
    container_name: graphiti_neo4j
    environment:
      - NEO4J_AUTH=neo4j/graphitipass
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_max__size=2G
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p graphitipass 'RETURN 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  # Graphiti - Temporal Knowledge Graph Service
  graphiti:
    image: python:3.11-slim
    container_name: graphiti_service
    working_dir: /app
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=graphitipass
      - GRAPHITI_PORT=8001
      # LLM Configuration - Use CLIProxyAPI
      - OPENAI_API_KEY=dummy-key-for-cliproxy
      - OPENAI_BASE_URL=http://clawdbot:8317/v1
      - LLM_MODEL=claude-sonnet-4-5-20250929
    ports:
      - "8001:8001"
    volumes:
      - ./graphiti:/app
      - graphiti-cache:/root/.cache
    depends_on:
      neo4j:
        condition: service_healthy
    restart: unless-stopped
    command: >
      bash -c "
      apt-get update && apt-get install -y curl &&
      pip install --no-cache-dir graphiti-core[neo4j] fastapi uvicorn &&
      if [ ! -f /app/server.py ]; then
        echo 'Error: Graphiti server.py not found!';
        exit 1;
      fi &&
      python /app/server.py
      "
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  clawdbot:
    build: .
    container_name: clawdbot_sandbox
    privileged: true  # Necessário para watchdog processar ops-requests
    cap_add:
      - ALL  # Adiciona todas as capabilities
    volumes:
      # Persist Clawdbot configuration (local sandbox)
      - ./data/clawdbot:/root/.clawdbot
      # Persist Gemini CLI credentials (local sandbox)
      - ./data/gemini:/root/.gemini
      # Persist workspace data (local sandbox)
      - ./data/workspace:/root/clawd
      # CLIProxyAPI OAuth credentials (compartilhado com host)
      - ./data/cli-proxy-api:/root/.cli-proxy-api
      # Cache para apt/pip (acelera instalações)
      - apt-cache:/var/cache/apt
      - pip-cache:/root/.cache/pip
    env_file:
      - .env
    environment:
      # Override workspace path to match container path
      - CLAWDBOT_WORKSPACE=/root/clawd
      # Permite instalações Python sem venv
      - PIP_BREAK_SYSTEM_PACKAGES=1
      # Graphiti integration
      - GRAPHITI_URL=http://graphiti:8001
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=graphitipass
    ports:
      - "18789:18789"
      - "8317:8317"  # CLIProxyAPI OAuth interface
    depends_on:
      - neo4j
      - graphiti
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'clawdbot-gateway' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command: clawdbot gateway --bind lan

volumes:
  apt-cache:
  pip-cache:
  neo4j-data:
  neo4j-logs:
  graphiti-cache:

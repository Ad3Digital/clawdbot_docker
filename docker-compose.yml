services:
  clawdbot:
    build: .
    container_name: clawdbot_sandbox
    privileged: true  # Necessário para watchdog processar ops-requests
    cap_add:
      - ALL  # Adiciona todas as capabilities
    volumes:
      # Persist Clawdbot configuration (local sandbox)
      - ./data/clawdbot:/root/.clawdbot
      # Persist Gemini CLI credentials (local sandbox)
      - ./data/gemini:/root/.gemini
      # Persist workspace data (local sandbox)
      - ./data/workspace:/root/clawd
      # CLIProxyAPI OAuth credentials (compartilhado com host)
      - ./data/cli-proxy-api:/root/.cli-proxy-api
      # Cache para apt/pip (acelera instalações)
      - apt-cache:/var/cache/apt
      - pip-cache:/root/.cache/pip
    env_file:
      - .env
    environment:
      # Override workspace path to match container path
      - CLAWDBOT_WORKSPACE=/root/clawd
      # Permite instalações Python sem venv
      - PIP_BREAK_SYSTEM_PACKAGES=1
    ports:
      - "18789:18789"
      - "8317:8317"  # CLIProxyAPI OAuth interface
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'clawdbot-gateway' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    command: clawdbot gateway --bind lan

volumes:
  apt-cache:
  pip-cache:
